/*
* uxDatagrid v.0.1.0
* (c) 2013, WebUX
* License: MIT.
*/
!function(a){function b(a,b,c){var d,e,f=0;if(a&&a.length)for(d=a.length;d>f;){if(e=b(a[f],f,a,c),void 0!==e)return e;f+=1}else for(f in a)if(a.hasOwnProperty(f)&&(e=b(a[f],f,a,c),void 0!==e))return e;return a}function c(a,b,c){function d(a,b){var c,d;d=h[a],d&&(b?(c=d.indexOf(b),-1!==c&&d.splice(c,1)):d.length=0)}function e(a,b){return h[a]=h[a]||[],h[a].push(b),function(){d(a,b)}}function f(b,c){return b&&b.apply(a,c)}function g(a){if(h[a])for(var b=0,c=h[a],d=c.length;d>b;)f(c[b],arguments),b+=1}var h={};b&&c?(a.on=b[c.on]&&b[c.on].bind(b),a.off=b[c.off]&&b[c.off].bind(b),a.dispatch=b[c.dispatch].bind(b)):(a.on=e,a.off=d,a.dispatch=g)}function d(a){for(var b=[],c=0,d=a.length;d>c;)b.push(a[c]),c+=1;return b}function e(a){function b(a){return a.toString().split(/\b/)[2]}function c(a,c,d){return{label:b(a),method:a,args:c||[],delay:d}}function d(a){var c=b(a);u[c]=a}function e(b){for(var c=0,d=t.length;d>c;)t[c].label===b.label&&t[c]!==s&&(a.log("flow:clear duplicate item %c%s",v,b.label),t.splice(c,1),c-=1,d-=1),c+=1}function f(a,b,d){var f=c(a,b,d);u[f.label]&&e(f),t.push(f),r&&k()}function g(a,b,d){t.splice(1,0,c(a,b,d))}function h(a){var b=a.toString(),c=b.match(/\(.*\)/);return c[0].match(/([\$\w])+/gm)}function i(a){var b=h(a);return!(!b||-1===b.indexOf("done"))}function j(){return q=Date.now(),a.log("flow:finish %c%s took %dms",v,s.label,q-p),s=null,t.shift(),t.length&&k(),q-p}function k(){!s&&t.length&&(s=t[0],a.async&&void 0!==s.delay?(a.log("	flow:delay for %c%s %sms",v,s.label,s.delay),clearTimeout(o),o=setTimeout(l,s.delay)):l())}function l(){a.log("flow:start method %c%s",v,s.label);var b=i(s.method);b&&s.args.push(j),p=Date.now(),s.method.apply(null,s.args),b||j()}function m(){r=!0,k()}function n(){clearTimeout(o),t.length=0,a=null}var o,p,q,r=!1,s=null,t=[],u={},v="font-weight: bold;color:#3399FF;";return a=a||{},a.async=a.hasOwnProperty("async")?a.async:!0,a.debug=a.hasOwnProperty("debug")?a.debug:!1,a.insert=g,a.add=f,a.unique=d,a.run=m,a.destroy=n,a.log=function(){a.debug&&console.log.apply(console,arguments)},a}function f(c,d,f,g){function h(){j(),T.unique(M),T.unique(F)}function i(){var a=angular.element('<div class="content"></div>');return d.append(a),a}function j(){hb.__name="ux-datagrid",hb.scope=c,hb.element=d,hb.attr=f,hb.rowsLength=0,hb.scopes=Z,hb.data=hb.data||[],hb.unwatchers=Y,hb.values=gb}function k(){hb.dispatch(a.datagrid.events.INIT),T.add(hb.templateModel.createTemplates),T.add(function(){W.dynamicRowHeights=hb.templateModel.dynamicHeights()}),T.add(l)}function l(){window.addEventListener("resize",n),Y.push(c.$on("$destroy",S)),T.add(m,[],0)}function m(){if(!X){X=!0;var a,b=0,d=null;Y.push(c.$watch(function(){var e=c.$eval(f.uxDatagrid);return a=e&&e.length||0,d===e&&b!==a&&T.add(N),d=e,b=a,e},function(){T.add(N)})),y(c)}}function n(b){Q(a.datagrid.events.RESIZE,{event:b})}function o(a){return Z[a]}function p(a){return angular.element(hb.chunkModel.getRow(a))}function q(a){return void 0===bb[a]&&(W.dynamicRowHeights?E():bb[a]=a*W.rowHeight),bb[a]}function r(a){return hb.templateModel.getTemplateHeight(hb.data[a])}function s(){return cb}function t(a){T.log("OVERWRITE DOM!!!");var b=a.length;T.add(hb.chunkModel.chunkDom,[a,W.chunkSize,'<div class="ux-datagrid-chunk">',"</div>",U],0),hb.rowsLength=b,ab={},T.log("created %s dom elements",b)}function u(a){var b,d,e,f,h=Z[a];return h||(h=c.$new(),b=o(a-1),d=hb.templateModel.getTemplate(hb.data[a]),b&&(b.$$nextSibling=h,h.$$prevSibling=b),h.$status="compiled",h[d.item]=hb.data[a],f=h.$watch(function(){h.digested=!0,f()}),Z[a]=h,e=p(a),e.removeClass(W.uncompiledClass),g(e)(h),z(h)),h}function v(a){fb=db.BUILDING,T.insert(t,[a],0)}function w(){fb=db.READY,T.add(M),T.add(x),T.add(y,[c])}function x(){c.$emit(a.datagrid.events.READY)}function y(a){a.$$phase||a.$digest()}function z(a){var b;if(a&&!B(a)){if(a.$$$watchers=a.$$watchers,a.$$watchers=[],a.$$childHead)for(b=a.$$childHead;b;)z(b),b=b.$$nextSibling;return!0}return!1}function A(a){var b;if(a&&a.$$$watchers){if(a.$$watchers=a.$$$watchers,a.$$$watchers=null,a.$$childHead)for(b=a.$$childHead;b;)A(b),b=b.$$nextSibling;return!0}return!(!a||a.$$$watchers)}function B(a){var b=Z[a];return!(!b||b.$$$watchers)}function C(a){var b=Math.floor(a/hb.templateModel.averageTemplateHeight()),c=0;for(bb[b]&&bb[b]<=a&&(c=b);c<hb.rowsLength;){if(bb[c]>a)return c-1;c+=1}return c}function D(){var a=cb,b={startIndex:0,i:0,inc:1,end:hb.rowsLength,visibleScrollStart:gb.scroll+W.cushion,visibleScrollEnd:gb.scroll+a-W.cushion};return b.startIndex=b.i=C(gb.scroll),b}function E(){for(var a=0,b=0;b<hb.rowsLength;)bb[b]=a,a+=hb.templateModel.getTemplateHeight(hb.data[b]),b+=1;W.rowHeight=hb.rowsLength?hb.templateModel.getTemplateHeight("default"):0}function F(){var a,b,d,e=D(),f=40*e.i,g=[].concat($);for(hb.dispatch(eb.BEFORE_UPDATE_WATCHERS,e),I(),$.length=0,T.log("	visibleScrollStart %s visibleScrollEnd %s",e.visibleScrollStart,e.visibleScrollEnd);e.i<hb.rowsLength&&(d=c.$$childHead?Z[e.i-1]:null,b=u(e.i),f=q(e.i),f>=e.visibleScrollStart&&f<=e.visibleScrollEnd&&(void 0===e.started&&(e.started=e.i),J(e.i),A(b)&&(a=g.indexOf(e.i),-1!==a&&g.splice(a,1),$.push(e.i),y(b))),e.i+=e.inc,!(e.inc>0&&f>e.visibleScrollEnd||e.inc<0&&f<e.visibleScrollStart)););e.ended=e.i-1,T.log("	startIndex %s endIndex %s",e.startIndex,e.i),G(g),_=e.visibleScrollStart,T.log("	activated %s",$.join(", ")),H(),T.add(y,[c]),hb.dispatch(eb.AFTER_UPDATE_WATCHERS,e)}function G(a){for(var b,c=[];a.length;)b=a.pop(),c.push(b),z(Z[b]);T.log("	deactivated %s",c.join(", "))}function H(){if($.length){var a=$[$.length-1],b=0,d=$.length;for(c.$$childHead=Z[$[0]],c.$$childTail=Z[a];d>b;)Z[$[b]].$$prevSibling=Z[$[b-1]],Z[$[b]].$$nextSibling=Z[$[b+1]],b+=1}}function I(){gb.activeRange.min=gb.activeRange.max=-1}function J(a){gb.activeRange.min=gb.activeRange.min<a&&gb.activeRange.min>0?gb.activeRange.min:a,gb.activeRange.max=gb.activeRange.max>a&&gb.activeRange.max>0?gb.activeRange.max:a}function K(){gb.dirty&&Q(a.datagrid.events.BEFORE_RENDER_AFTER_DATA_CHANGE)}function L(){gb.dirty&&(V&&(V.remove(),V=null),gb.dirty=!1,Q(a.datagrid.events.RENDER_AFTER_DATA_CHANGE))}function M(){if(fb===db.BUILDING)cb=d[0].offsetHeight,T.add(v,[hb.data],0),T.add(E),T.add(w);else{if(fb!==db.READY)throw new Error("RENDER STATE INVALID");T.add(K),T.add(F),T.add(L)}}function N(){Q(a.datagrid.events.BEFORE_DATA_CHANGE),gb.dirty=!0,T.log("dataChanged"),hb.data=hb.setData(c.$eval(f.uxDatagrid||f.list),c.$eval(f.grouped))||[],Q(a.datagrid.events.AFTER_DATA_CHANGE),T.add(O)}function O(){R(),bb={},ab={},$.length=0,Z.length=0,U&&(V=U,V.css({position:"absolute",top:0,left:0,zIndex:1})),U=i(),cb=0,j(),hb.chunkModel.reset(),fb=db.BUILDING,T.add(M)}function P(a){var b=Z[a];!b&&a>0&&a<hb.rowsLength&&(b=u(a)),b&&!c.$$phase&&(A(b),b.$digest(),z(b))}function Q(){c.$emit.apply(c,arguments)}function R(){var a,d,e=0;b(Z,function(b,c){if(b){for(b.$$prevSibling=a||void 0,e=c;!d&&e<hb.rowsLength;)e+=1,d=Z[e]||void 0;A(b),a=b,b.$destroy()}}),c.$$childHead=void 0,c.$$childTail=void 0,Z.length=0}function S(){for(c.datagrid=null,T.log("destroying grid"),clearTimeout(gb.scrollingStopIntv),T.destroy(),hb.flow=void 0,T=null;Y.length;)Y.pop()();R();for(var a in hb)hb[a]&&hb[a].hasOwnProperty("destroy")&&hb[a].destroy(),hb[a]=null;d.remove(),hb=null,c=null,d=null,f=null,Y=null,U=null,$.length=0,$=null,Z.length=0,Z=null,gb=null,db=null,eb=null,g=null}var T,U,V,W,X=!1,Y=[],Z=[],$=[],_=0,ab={},bb={},cb=0,db=a.datagrid.states,eb=a.datagrid.events,fb=db.BUILDING,gb={dirty:!1,scroll:0,speed:0,absSpeed:0,scrollingStopIntv:null,activeRange:{min:0,max:0}},hb={};return hb.start=k,hb.reset=O,hb.forceRenderScope=P,hb.dispatch=Q,hb.render=function(){T.add(M)},hb.updateAllHeights=E,hb.getOffsetIndex=C,hb.isActive=B,hb.getScope=o,hb.getRowElm=p,hb.getRowOffset=q,hb.getRowHeight=r,hb.getViewportHeight=s,hb.options=W=angular.extend({},a.datagrid.options,c.$eval(f.options)||{}),hb.flow=T=new e({async:W.hasOwnProperty("async")?!!W.async:!0,debug:W.hasOwnProperty("debug")?!!W.debug:!1}),T.add(h),T.run(),hb}var g;try{g=angular.module("ux",["ng"])}catch(h){g=angular.module("ux")}a.datagrid={states:{BUILDING:"datagrid:building",APPENDING:"datagrid:appending",READY:"datagrid:ready",DEACTIVATED:"datagrid:deactivated",ACTIVATED:"datagrid:activated"},events:{INIT:"datagrid:init",RESIZE:"datagrid:resize",READY:"datagrid:ready",BEFORE_UPDATE_WATCHERS:"datagrid:beforeUpdateWatchers",AFTER_UPDATE_WATCHERS:"datagrid:afterUpdateWatchers",BEFORE_DATA_CHANGE:"datagrid:beforeDataChange",AFTER_DATA_CHANGE:"datagrid:afterDataChange",BEFORE_RENDER_AFTER_DATA_CHANGE:"datagrid:beforeRenderAfterDataChange",RENDER_AFTER_DATA_CHANGE:"datagrid:renderAfterDataChange"},options:{compileAllRowsOnInit:!1,updateDelay:100,cushion:-50,chunkSize:100,uncompiledClass:"uncompiled",dynamicRowHeights:!1,renderThreshold:50,creepLimit:20},coreAddons:[]},g.factory("addons",["$injector",function(a){function b(b,c){for(var d,e=0,f=b.length;f>e;){if(d=a.get(b[e]),"function"!=typeof d)throw new Error("Addons expect a function to pass the grid instance to.");d(c),e+=1}}return function(a,c){c=c instanceof Array?c:c&&c.replace(/\s+/g,"").split(",")||[],a.addons&&(c=a.addons=a.addons.concat(c)),b(c,a)}}]),a.css=function(){function a(a){return b(a)||(e[a]=c(a)),b(a)}function b(a){return e[a]}function c(a){if(document.styleSheets&&0!==document.getElementsByTagName(f.head).length){var b,c,d,e;if(document.styleSheets.length>0)for(d=0;d<document.styleSheets.length&&(document.styleSheets[d].disabled||(e=document.styleSheets[d].media,c=typeof e,c===f.string?(""===e||-1!==e.indexOf(f.screen))&&(b=document.styleSheets[d]):c===f.object&&(""===e.mediaText||-1!==e.mediaText.indexOf(f.screen))&&(b=document.styleSheets[d]),"undefined"==typeof b));d++);var g=document.createElement("style");for(g.type="text/css",g.title=a,document.getElementsByTagName(f.head)[0].appendChild(g),d=0;d<document.styleSheets.length;d++)document.styleSheets[d].disabled||(b=document.styleSheets[d]);return{name:a,styleSheet:b}}}function d(c,d,e){var f,g=b(c)||a(c),h=g.styleSheet;if(h.addRule){for(f=0;f<h.rules.length;f++)if(h.rules[f].selectorText&&h.rules[f].selectorText.toLowerCase()===d.toLowerCase())return h.rules[f].style.cssText=e,void 0;h.addRule(d,e)}else if(h.insertRule){for(f=0;f<h.cssRules.length;f++)if(h.cssRules[f].selectorText&&h.cssRules[f].selectorText.toLowerCase()===d.toLowerCase())return h.cssRules[f].style.cssText=e,void 0;h.insertRule(d+"{"+e+"}",0)}}var e={},f={head:"head",screen:"screen",string:"string",object:"object"};return{createdStyleSheets:[],createStyleSheet:c,createClass:d}}(),a.each=b,a.util=a.util||{},a.util.array=a.util.array||{},a.util.array.toArray=d,a.datagrid.Flow=e,g.directive("uxDatagrid",["$compile","addons",function(c,d){return{restrict:"AE",link:function(e,g,h){var i=new f(e,g,h,c);e.datagrid=i,b(a.datagrid.coreAddons,function(a){a.apply(i,[i])}),d(i,h.addons),i.start()}}}]);var i=function(){};i.prototype=Array.prototype,i.prototype.min=0,i.prototype.max=0,i.prototype.templateStart="",i.prototype.templateEnd="",i.prototype.getStub=function(a){return this.templateStart+a+this.templateEnd},i.prototype.getChildrenStr=function(a){for(var b=0,c=this.length,d="",e=this;c>b;)d+=e[b]instanceof i?e[b].getStub(a?e[b].getChildrenStr(a):""):this.templateModel.getTemplate(e[b]).template,b+=1;return this.rendered=!0,d},i.prototype.destroy=function(){this.templateStart="",this.templateEnd="",this.templateModel=null,this.rendered=!1,this.length=0},a.datagrid.coreAddons.chunkModel=function(a){function b(){return m}function d(b,c,f,g){for(var h,j,k=0,l=b.length,m=new i;l>k;)j=b[k],k%c===0&&(h&&e(h),h=new i,h.min=j.min||k,h.templateModel=a.templateModel,h.templateStart=f,h.templateEnd=g,m.push(h)),h.push(j),h.max=j.max||k,k+=1;return h&&e(h),m.min||(m.min=m[0]?m[0].min:0,m.max=m[m.length-1]?m[m.length-1].max:0,m.templateStart=f,m.templateEnd=g,e(m)),m.length>c?d(m,c,f,g):m}function e(b){if(b[0]instanceof i){for(var c=0,d=b.length,e=0;d>c;)e+=b[c].height,c+=1;b.height=e}else b.height=a.templateModel.getHeight(n,b.min,b.max);b.templateStart=b.templateStart.substr(0,b.templateStart.length-1)+' style="width:100%;height:'+b.height+'px;">'}function f(a,b,c,e,f){return p=f,o=b,n=a,m=d(a,b,c,e),f}function g(a,b,c){var d,e=0,f=b.length;for(c=c||[];f>e;){if(d=b[e],!(d instanceof i)){c.push(a%o);break}if(a>=d.min&&a<=d.max){c.push(e),g(a,d,c);break}e+=1}return c}function h(a){var b=g(a,m);return j(b)}function j(a){for(var b,c=0,d=a.slice(0),e=m,f=p;c<d.length;)b=d.shift(),e.rendered||f.html(e.getChildrenStr()),e=e[b],f=angular.element(f.children()[b]);return f}function k(){m&&m.destroy(),n=null,m=null,o=null,p=null}function l(){k()}var m,n,o,p,q={};return q.chunkDom=f,q.getChunkList=b,q.getRowIndexes=function(a){return g(a,m)},q.getRow=h,q.reset=k,q.destroy=l,c(q),a.chunkModel=q,q},a.datagrid.coreAddons.push(a.datagrid.coreAddons.chunkModel),a.datagrid.events.RENDER_PROGRESS="datagrid:renderProgress",a.datagrid.coreAddons.creepRenderModel=function(c){function d(a){var b=c.getScope(a);b&&b.digested||c.forceRenderScope(a)}function e(){var a={count:0};return b(c.scopes,f,a),a.count/c.rowsLength}function f(a,b,c,d){d.count+=a?1:0}function g(b,f){for(var g=b,j=f,k=Date.now()+c.options.renderThreshold;k>Date.now()&&(g>=0||j<c.rowsLength);)g>=0&&(d(g),g-=1),j<c.rowsLength&&(d(j),j+=1);l=e(),h(),m+=1,!c.values.speed&&c.scopes.length<c.rowsLength&&i(g,j),c.dispatch(a.datagrid.events.RENDER_PROGRESS,l)}function h(){k=!1}function i(a,b){h(),m<c.options.creepLimit&&(c.flow.add(g,[a,b],c.options.renderThreshold),k=!0)}function j(a,b){k||(m=0,i(b.started,b.ended))}var k=0,l=0,m=0,n={};n.destroy=function(){c=null,n=null},c.unwatchers.push(c.scope.$on(a.datagrid.events.BEFORE_UPDATE_WATCHERS,h)),c.unwatchers.push(c.scope.$on(a.datagrid.events.AFTER_UPDATE_WATCHERS,j))},a.datagrid.coreAddons.push(a.datagrid.coreAddons.creepRenderModel),a.datagrid.coreAddons.normalizeModel=function(a){function b(a,c,d){var e=0,f=a.length;for(d=d||[];f>e;)d.push(a[e]),a[e]&&a[e][c]&&b(a[e][c],c,d),e+=1;return d}var c,d;return a.setData=function(a,e){return c=a,d=e?b(a,e):a.slice(0)},a.getData=function(){return d},a.getOriginalData=function(){return c},a.getNormalizedIndex=function(b){return a.data.indexOf(b)},a},a.datagrid.coreAddons.push(a.datagrid.coreAddons.normalizeModel),a.datagrid.events.SCROLL_START="datagrid:scrollStart",a.datagrid.events.SCROLL_STOP="datagrid:scrollStop",a.datagrid.coreAddons.scrollModel=function(b){function c(){b.element[0].addEventListener("scroll",e.onUpdateScroll),b.unwatchers.push(function(){b.element[0].removeEventListener("scroll",e.onUpdateScroll)})}function d(){}var e={};return e.onUpdateScroll=function(c){var d=(c.target||c.srcElement||b.element[0]).scrollTop;b.values.scroll!==d&&(b.dispatch(a.datagrid.events.SCROLL_START,d),b.values.speed=d-b.values.scroll,b.values.absSpeed=Math.abs(b.values.speed),b.values.scroll=d),e.waitForStop()},e.scrollTo=function(a,c){b.element[0].scrollTop=a,c?(b.values.scroll=a,clearTimeout(b.values.scrollingStopIntv),e.onScrollingStop()):e.waitForStop()},e.waitForStop=function(){b.flow.async?(clearTimeout(b.values.scrollingStopIntv),b.values.scrollingStopIntv=setTimeout(e.onScrollingStop,b.options.updateDelay)):e.onScrollingStop()},e.onScrollingStop=function(){b.values.speed=0,b.values.absSpeed=0,b.flow.add(b.render),b.dispatch(a.datagrid.events.SCROLL_STOP,b.values.scroll)},e.scrollToIndex=function(a){var c=b.getRowOffset(a);return e.scrollTo(c),c},e.scrollToItem=function(a){var c=b.getNormalizedIndex(a);return-1!==c?e.scrollToIndex(c):b.values.scroll},b.scope.$on(a.datagrid.events.READY,c),e.destroy=d,b.scrollModel=e,b},a.datagrid.coreAddons.push(a.datagrid.coreAddons.scrollModel),a.datagrid.coreAddons.templateModel=function(a){"use strict";function b(a){return a=a.replace(/\n/g,""),a=a.replace(/[\t ]+</g,"<"),a=a.replace(/>[\t ]+</g,"><"),a=a.replace(/>[\t ]+$/g,">")}return a.templateModel=function(){function c(){var b,c=a.element[0].getElementsByTagName("script"),e=c.length;if(!e)throw new Error("at least one template is required.");for(b=0;e>b;b+=1)d(c[b]);for(;c.length;)a.element[0].removeChild(c[0])}function d(c){var d,e=b(angular.element(c).html()),f=document.createElement("div");return e=angular.element(e)[0],e.className+=" "+a.options.uncompiledClass+" {{$status}}",f.appendChild(e),document.body.appendChild(f),e=b(f.innerHTML),d={name:c.attributes["data-template-name"].nodeValue||"default",item:c.attributes["data-template-item"].nodeValue,template:e,height:f.offsetHeight},o[d.name]=d,o.push(d),document.body.removeChild(f),n=0,d}function e(){return o}function f(a){return g(a._template)}function g(a){return o[a]?o[a]:o["default"]}function h(){var a,b;for(a in o)if(o.hasOwnProperty(a)&&(b=b||o[a].height,b!==o[a].height))return!0;return!1}function i(){var a=0,b=o.length;if(!n)for(;b>a;)n+=o[a].height,a+=1;return n/b}function j(){return o.length}function k(a){return f(a).height}function l(a,b,c){var d=b,e=0;if(!a.length)return 0;for(;c>=d;)e+=k(a[d]),d+=1;return e}function m(){o.length=0,o=null}var n,o=[];return{createTemplates:c,getTemplates:e,getTemplate:f,getTemplateByName:g,templateCount:j,dynamicHeights:h,averageTemplateHeight:i,getHeight:l,getTemplateHeight:k,destroy:m}}(),a.templateModel},a.datagrid.coreAddons.push(a.datagrid.coreAddons.templateModel)}(this.ux=this.ux||{},function(){return this}());